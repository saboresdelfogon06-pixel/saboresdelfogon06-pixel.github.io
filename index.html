<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sabores del Fog√≥n</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="preload" as="image" href="images/IMG_7762.webp" type="image/webp" fetchpriority="high">
<link rel="icon" href="images/LOGO96.webp" type="image/webp" sizes="96x96">
<link rel="preconnect" href="https://connect.facebook.net">

<style>
:root{
  --bg:#0f0f0f;
  --card:#1b1b1b;
  --text:#cfcac2;
  --muted:#9a958d;
  --accent:#D3AE09;
}
body {
  margin: 0;
  font-family: Arial, sans-serif;
  background: var(--bg);
  color: var(--text);
  touch-action: manipulation;
  overscroll-behavior: none;
  height: 100%;      /* Ocupa toda la altura del viewport */
  overflow-y: auto;  /* Permite el scroll en el eje vertical */
}
 
.container {
  max-width: 720px;
  margin: auto;
  padding: 16px;
  padding-top: 72px; /* altura del mini-banner + margen extra */
  
  height: 100%;       /* ocupa toda la pantalla */
  overflow-y: auto;   /* scroll solo dentro del contenido */
  -webkit-overflow-scrolling: touch; /* suaviza scroll en iOS */
}
/* HEADER */
.header{
  display:flex;
  align-items:center;
  gap:14px;
  margin-bottom:14px;
}
.logo{width:54px}
.brand{
  font-size:15px;
  color:var(--muted);
}
.brand a{
  color:var(--muted);
  text-decoration:none;
}
.brand span{margin:0 6px;opacity:.6}

/* SECTIONS */
.section{
  background:var(--card);
  border-radius:12px;
  padding:10px;
  margin-bottom:16px;
}

label{
  display:block;
  font-size:14px;
  color:var(--muted);
  margin-bottom:6px;
}

.control{
  width:100%;
  padding:14px;
  background:#111;
  color:var(--text);
  border:1px solid #333;
  border-radius:8px;
  margin-bottom:10px;
  box-sizing:border-box;
}

button.control{cursor:pointer;text-align:left}
button.selected{
  border-color:var(--accent);
  background:rgba(211,174,9,.15);
}

/* TABS */
.tabs{
  display:flex;
  gap:6px;
  overflow-x:auto;
  margin-bottom:12px;
}
.tab{
  min-width:90px;
  padding:10px;
  text-align:center;
  background:#111;
  border-radius:8px;
  cursor:pointer;
}
.tab.active{
  background:var(--accent);
  color:#1b1b1b;
}

/* TOP */
.picada-top{
  display:flex;
  gap:16px;
  align-items:flex-start;
}

/* IMAGE */
.image-box{
  width:160px;
  height:160px;
  background:#000;
  border-radius:12px;
  overflow:hidden;
  flex-shrink:0;
  display:flex;
  align-items:center;
  justify-content:center;
  color:var(--muted);
  font-size:12px;
  text-align:center;
  cursor:pointer;
}
.image-box img{
  width:100%;
  height:100%;
  object-fit:cover;
}

/* MODEL */
.model-column{flex:1}
.model-info{
  font-size:14px;
  line-height:1.5;
  color:var(--muted);
  margin:8px 0 14px;
}
.model-info b{color:var(--text)}

.summary{font-size:15px;line-height:1.5}


.pay button{
  width:100%;
  padding:18px;
  font-size:20px;
  background:var(--accent);
  border:none;
  border-radius:10px;
  color:#2a2a2a;
  cursor:pointer;
  opacity:1;
  transition: all .3s ease; /* <- transici√≥n m√°s suave */
  font-weight: 600;
  box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* sombra base */
}

.pay button.enabled{
  background: #e0b800;
  box-shadow: 0 6px 12px rgba(0,0,0,0.4); /* sombra m√°s grande al habilitar */
}

.pay button.enabled:hover{
  transform: translateY(-2px);   /* efecto de ‚Äúlevantarse‚Äù al hover */
  box-shadow: 0 8px 16px rgba(0,0,0,0.5); /* sombra m√°s intensa */
}


.small{text-align:center;font-size:13px;color:var(--muted)}

/* MODAL */
.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.85);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:999;
}
.modal img{
  max-width:90%;
  max-height:80%;
  border-radius:12px;
}
.modal button{
  position:absolute;
  top:20px;
  right:20px;
  background:var(--accent);
  border:none;
  padding:10px 14px;
  border-radius:8px;
}
.banner{
  width:100%;
  margin-top: 8px;
  height:220px;
  border-radius:14px;
  overflow:hidden;
  position:relative;
  margin-bottom:16px;
  background:#000;
  touch-action:pan-y;
}

@media (max-width:480px){
  .banner{
    height:180px;
  }
}

.banner-track{
  display:flex;
  height:100%;
  transition:transform .6s ease;
}

.banner-slide{
  min-width:100%;
  height:100%;
}

.banner-slide img,
.banner-slide video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.banner-model{
  position:absolute;
  top:12px;
  right:12px;
  padding:6px 12px;
  background:rgba(0,0,0,.35);
  backdrop-filter: blur(6px);
  color:#fff;
  font-size:13px;
  letter-spacing:.3px;
  border-radius:999px;
  font-weight:500;
  z-index:10;
}
.banner::after{
  content:"";
  position:absolute;
  inset:auto 0 0 0;
  height:60%;
  background:linear-gradient(
    to top,
    rgba(0,0,0,.45),
    rgba(0,0,0,.15),
    transparent
  );
  pointer-events:none;
  z-index:5;
}

#config .picada-top{
  margin-top:4px;
}
@media (max-width:480px){
  #config{
    margin-bottom:8px;
  }
}

/* ===============================
   MEJOR LEGIBILIDAD EN M√ìVIL
   estilo Instagram / Twitter
   =============================== */
@media (max-width:480px){

  body{
    font-size:14px;
  }

  .control,
  select.control,
  button.control{
    font-size:12px;
  }

  label{
    font-size:13px;
  }

  .summary{
    font-size:14px;
  }

  .pay button{
    font-size:18px;
  }
}

@keyframes blink-gold {
  0%, 100% { border-color: var(--accent); background: rgba(211,174,9,0.15); }
  50% { border-color: var(--accent); background: transparent; }
}

.model-hint {
  animation: blink-gold 0.8s ease-in-out 2; /* parpadea dos veces */
}

.error-msg {
  color: #ff4d4f;
  font-size: 12px;
  margin-top: -6px;
  margin-bottom: 6px;
}
.mini-banner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #1b1b1b;  /* gris oscuro */
  height: 48px;          /* altura fija */
  line-height: 48px;     /* centrar texto verticalmente */
  padding: 0 12px;
  font-size: 13px;
  color: #fff;
  border-radius: 12px;  
  box-shadow: 0 2px 6px rgba(0,0,0,0.3);
  z-index: 999;

  position: fixed;       /* ‚ö° aqu√≠ est√° la clave */
  top: 12px;             /* separaci√≥n desde arriba */
  left: 12px;            /* separaci√≥n lateral */
  right: 12px;           /* separaci√≥n lateral */
  transition: transform 0.3s ease; /* opcional, suaviza el movimiento al aparecer/desaparecer */
}


.mini-banner .left {
  display: flex;
  align-items: center;
  gap: 6px;
}

.mini-banner .left a {
  color: #fff;           /* IG siempre blanco */
  text-decoration: none;
  font-weight: 500;
}

.mini-banner .left .logo {
  width: 36px;  
}


.mini-banner .right .cart-total {
  background: #333;      /* gris m√°s oscuro, uniforme con la est√©tica */
  padding: 4px 8px;
  border-radius: 8px;
  font-weight: bold;
  font-size: 12px;
}

.container {
  max-width: 720px;
  margin: auto;
  padding: 16px;
  padding-top: 72px; /* altura del mini-banner + margen extra */
}

.favicon {
  width: 96px;           /* Tama√±o del favicon (cuadrado) */
  height: 96px;          /* Tama√±o del favicon (cuadrado) */
  background-image: url('images/LOGO.webp');  /* Ruta de tu imagen */
  background-size: 100% 100%;  /* Asegura que la imagen no se deforme */
  background-repeat: no-repeat;  /* No repetir la imagen */
  background-position: center;  /* Centra la imagen dentro del contenedor */
}

.control.error {
  border-color: var(--accent);
  background: rgba(211,174,9,0.12);
  animation: blink-gold 0.8s ease-in-out 2;
}

@keyframes blink-red {
  0%, 100% { border-color: #ff4d4f; background: rgba(255,77,79,0.1); }
  50% { border-color: #ff4d4f; background: transparent; }
}

.date-time-row{
  display:flex;
  gap:10px;
  align-items:flex-start; /* üëà clave */
}


/* Desktop */
@media (min-width: 481px){
  .date-time-row .date{
    flex: 0 0 45%;   /* achica SOLO el campo visible */
  }

  #deliveryTime{
    flex: 1;
  }
}

@media (max-width: 480px){
  .date-time-row{
    flex-direction: row;   /* üëà en fila */
  }

  .date-time-row .date,
  #deliveryTime{
    flex: 1;              /* üëà 50% y 50% */
  }
}


.delivery-hint{
  font-size:12px;
  color: var(--muted);
  margin-top:-4px;   /* üëà lo acerca al horario */
  margin-bottom:12px; /* üëà separa de Localidad */
}


/* ===== NORMALIZAR INPUT DATE ===== */
input[type="date"].control{
  padding:12px;               /* igual que .control */
  background:#111;
  color:var(--text);
  border:1px solid #333;
  border-radius:8px;
  font-size:14px;
  line-height: normal;

  /* quita estilos nativos */
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

input[type="date"].control{
  min-height:48px;
  display:flex;
  align-items:center;
  justify-content:flex-start; /* üëà fuerza texto a la izquierda */
  text-align:left;            /* üëà consistente con otros campos */
}

  
/* icono calendario (WebKit: Chrome, Safari, iOS) */
input[type="date"]::-webkit-calendar-picker-indicator{
  filter: invert(1) opacity(0.6);
  cursor:pointer;
}

/* Firefox */
input[type="date"]::-moz-focus-inner{
  border:0;
}

.zone-row{
  display:flex;
  gap:10px;
}

@media (max-width:480px){
  .zone-row > div{
    flex:1;   /* 50% / 50% */
  }
}

.section.summary{
  padding:14px;
}

.summary-close{
  position:absolute;
  top:10px;
  right:10px;
  background:none;
  border:none;
  color:var(--muted);
  font-size:18px;
  cursor:pointer;
}

.summary-content{
  display:flex;
  flex-direction:column;
  gap:12px;
  padding-top: 32px; /* üëà espacio reservado para la X */
}


.summary-items{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.summary-item{
  display:grid;
  grid-template-columns: 1fr auto;
  gap:6px 12px;
  padding-bottom:8px;
  border-bottom:1px dashed #333;
}

.item-title{
  font-size:14px;
  font-weight:600;
}

.item-desc{
  grid-column:1 / 2;
  font-size:13px;
  color:var(--muted);
}

.item-price{
  grid-row:1 / 3;
  align-self:center;
  font-weight:600;
}

.summary-shipping{
  display:grid;
  grid-template-columns:1fr auto;
  font-size:14px;
  color:var(--muted);
}

.summary-total{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding-top:10px;
  margin-top:6px;
  border-top:1px solid #444;
  font-size:18px;
  font-weight:700;
  color:var(--accent);
}

.summary-warning{
  font-size:13px;
  color:#ff4d4f;
  text-align:center;
  margin-top:4px;
}
.model-size-grid{
  display:flex;
  gap:12px;
}

/* Columnas */
.model-col,
.size-col{
  flex:1;
}

/* Mobile */
@media (max-width:480px){
  .model-size-grid{
    flex-direction:row;
  }

  .model-col button,
  .size-col button{
    padding:10px;
    font-size:12px;
  }
}

  

</style>
</head>
<body>

<div class="modal" id="imgModal" onclick="closeModal()">
  <button>Cerrar</button>
  <img id="modalImg">
</div>

<div class="container">

<div class="mini-banner">
  <div class="left">
    <img src="images/LOGO.webp" class="logo">
    <a href="https://www.instagram.com/saboresfogon.ar/" target="_blank">@saboresfogon.ar</a>
  </div>
  <div class="right">
    <div class="cart-total" id="cartTotal">
      $0
    </div>
  </div>
</div>

<!-- ===== HERO BANNER ===== -->
<div class="banner" id="heroBanner">

  <div class="banner-track" id="bannerTrack"></div>

  <div class="banner-model" id="bannerModel">
    Cl√°sica y Elegante
  </div>

</div>


<div id="config"></div>
<label style="font-size:12px;">√öltimo paso para confirmar tu pedido:</label>
<div class="section">
<label>Nombre y apellido</label>
<input id="clientName" class="control" placeholder="Ingrese su nombre completo" oninput="update()">
<div class="error-msg" id="error-clientName"></div>

<label>Fecha y horario de entrega</label>

<div class="date-time-row">
  <!-- FECHA -->
  <input
    id="orderDate"
    type="date"
    class="control date"
    oninput="update()"
  >

  <!-- HORARIO -->
  <select id="deliveryTime" class="control" onchange="update()">
    <option value="">Horarios de entrega</option>
    <option value="11-14">11:00 a.m ‚Äì 14:00 p.m</option>
    <option value="15-19">15:00 p.m ‚Äì 19:00 p.m</option>
  </select>
</div>

<!-- TEXTO ACLARATIVO (FUERA DEL FLEX) -->
<div class="delivery-hint">
  El horario puede variar hasta una hora m√°s tarde.
</div>


<div class="error-msg" id="error-orderDate"></div>

<div class="zone-row">
  <div>
    <label>Localidad</label>
    <select id="zone" class="control" onchange="handleZoneChange()">
  <option value="">Seleccionar localidad</option>
  <option value="manual">Ingresar manualmente</option>

  <option value="Francisco √Ålvarez|0">Francisco √Ålvarez</option>
  <option value="La reja|0">La reja</option>
  <option value="Moreno|0">Moreno</option>

  <option value="Paso del Rey|5000">Paso del Rey</option>  
  <option value="General Rodr√≠guez|8000">General Rodr√≠guez</option>
  <option value="Merlo|8000">Merlo</option>
  <option value="Ituzaing√≥|8000">Ituzaing√≥</option>
  <option value="San Antonio de Padua|8000">San Antonio de Padua</option>
  <option value="Mor√≥n|8000">Mor√≥n</option>
  <option value="Castelar|8000">Castelar</option>
  <option value="Hurlingham|8000">Hurlingham</option>
  <option value="La Matanza|8000">La Matanza</option>
  <option value="Ramos Mej√≠a|8000">Ramos Mej√≠a</option>
  <option value="San Justo|8000">San Justo</option>

  <option value="San Miguel|8000">San Miguel</option>
  <option value="Vicente L√≥pez|8000">Vicente L√≥pez</option>
  <option value="Olivos|8000">Olivos</option>
  <option value="San Isidro|8000">San Isidro</option>
  <option value="Pilar|8000">Pilar</option>

  <option value="Ciudad Aut√≥noma de Buenos Aires (CABA)|8000">
    Ciudad Aut√≥noma de Buenos Aires (CABA)
  </option>

</select>

    <input
  type="text"
  id="manualZone"
  class="control"
  placeholder="Ingres√° tu localidad"
  style="display:none;"
  oninput="setZoneManual()"
/>

  </div>
  
 <div>
    <label>Direcci√≥n y altura</label>
    <input id="addr" class="control" placeholder="Ingrese la direcci√≥n" oninput="update()">
  </div>
</div>
<div class="error-msg" id="error-addr"></div>
<label>WhatsApp</label>
<input
  id="clientWhatsapp"
  class="control"
  placeholder="Ej: 1123456789"
  inputmode="numeric"
  maxlength="10"
  oninput="handleWhatsappInput()"
/>
<div class="error-msg" id="error-clientWhatsapp"></div>

<div class="error-msg" id="error-zone"></div>

</div>

<div class="section summary" style="position:relative">


  <div id="summary">
    Complet√° todos los pasos para ver el total.
  </div>

</div>

<div class="pay">
<button id="payBtn" onclick="goWA()">Pagar</button>
</div>

<p class="small">Ser√°s redirigido a Mercado Pago para completar el pago de forma segura.</p>

</div>
<script>
const ORDERS_API_URL = 'https://script.google.com/macros/s/AKfycbyZfBtAjy8VaJgi_311oil8qrIuZ8rg9UqWz6WqP9en_wPNOo1fZTEF3Zp_TanZtDL7lQ/exec';
const clientName = document.getElementById('clientName');
const deliveryTime = document.getElementById('deliveryTime');
const orderDate  = document.getElementById('orderDate');
const addr       = document.getElementById('addr');
const zone       = document.getElementById('zone');
const summary    = document.getElementById('summary');
const payBtn     = document.getElementById('payBtn');
const config     = document.getElementById('config');
const imgModal = document.getElementById('imgModal');
const modalImg = document.getElementById('modalImg');
const clientWhatsapp = document.getElementById('clientWhatsapp');
document.addEventListener('DOMContentLoaded', () => {
  const dateInput = document.getElementById('orderDate');
  if (!dateInput) return;

  // fecha m√≠nima = hoy + 2
  const minDate = new Date();
  minDate.setDate(minDate.getDate() + 2);
  const minDateStr = minDate.toISOString().split('T')[0];

  dateInput.min = minDateStr;

  // üëâ si no hay fecha guardada, usar la m√°s cercana disponible
  const savedDate = localStorage.getItem('orderDate');
  if (!savedDate) {
    dateInput.value = minDateStr;
    localStorage.setItem('orderDate', minDateStr);
  }
});




// ===== FIN M√ìDULO 1 =====

  function highlightPicada(index){
  // activar la picada problem√°tica
  active = index;
  saveState();
  renderConfig();

  setTimeout(() => {
    const picadaTop = document.querySelector('.picada-top');
    if(!picadaTop) return;

    picadaTop.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });

    const modelBtns = picadaTop.querySelectorAll('button.control');
    modelBtns.forEach(btn => {
      btn.classList.remove('model-hint');
      setTimeout(() => btn.classList.add('model-hint'), 50);
    });
  }, 80);
}

const modelData={
 "Cl√°sica y Elegante":{
  img:"images/IMG_7762.webp",
  fiambres:["Sopresatta italiana","Jam√≥n crudo","Lomo ahumado","Panceta ahumada"],
  quesos:["Brie","Queso azul","Pepato"],
  dips:["Dip dulce","Dip salado"]
 },
 "Fresca y Colorida":{
  img:"images/IMG_7761.webp",
  fiambres:["Jam√≥n cocido","Salam√≠n chacarero","Longaniza","Panceta ahumada"],
  quesos:["Brie","Pategr√°s","Sardo"],
  dips:["Dip dulce","Dip salado"]
 }
};

let picadas=[],active=0,ship=0,zoneName="", total=0;

// =========================
// TAB GUARD (PEDIDO POR PESTA√ëA)
// =========================
const TAB_KEY = 'sf_tab_initialized';

(function tabGuard() {
  const navType = performance.getEntriesByType("navigation")[0]?.type;

  // SOLO nueva pesta√±a real
  if (navType === "navigate" && !sessionStorage.getItem(TAB_KEY)) {
    sessionStorage.setItem(TAB_KEY, '1');

    localStorage.removeItem('picadas');
    localStorage.removeItem('clientName');
    localStorage.removeItem('orderDate');
    localStorage.removeItem('addr');
    localStorage.removeItem('zone');
    localStorage.removeItem('scrollY');
    localStorage.removeItem('activePicada');
    localStorage.removeItem('clientWhatsapp');

    sessionStorage.removeItem('mp_init_point');
    sessionStorage.removeItem('order_fingerprint');
  }
})();


const PRICES = {
  1: 300,      // üëà TEST
  4: 50000,
  6: 70000,
  8: 90000
};

const SIZE_INFO = {
  4: { pican: 6, medidas: "20 √ó 30 cm" },
  6: { pican: 8, medidas: "28 √ó 48 cm" },
  8: { pican: 12, medidas: "28 √ó 48 cm" }
};



function getOrderFingerprint() {
  return JSON.stringify({
    picadas,
    envio: ship,
    zoneName
  });
}

function generateOrderId() {
  // Genera un ID temporal para mostrar mientras se hace el pedido
  const randomNum = Math.floor(Math.random() * 999999) + 1;
  return `SF-${String(randomNum).padStart(6, "0")}`;
}



function generateToken() {
  return crypto.randomUUID().replace(/-/g,'');
}

if (!sessionStorage.getItem('order_id')) {
  const hasSavedOrder = !!localStorage.getItem('picadas');
  sessionStorage.setItem(
    'order_id',
    hasSavedOrder ? generateOrderId() : generateOrderId()
  );
}

if (!sessionStorage.getItem('token')) {
  sessionStorage.setItem('token', generateToken());
}

window.currentOrderId = sessionStorage.getItem('order_id');
window.currentToken   = sessionStorage.getItem('token');

function saveState(){
  localStorage.setItem('picadas', JSON.stringify(picadas));
  localStorage.setItem('activePicada', active); // üëà NUEVO
  localStorage.setItem('clientName', clientName.value);
  localStorage.setItem('orderDate', orderDate.value);
  localStorage.setItem('addr', addr.value);
  localStorage.setItem('zone', zone.value);
  localStorage.setItem('clientWhatsapp', clientWhatsapp.value);
  localStorage.setItem('deliveryTime', deliveryTime.value);
}


function loadState() {
  clientWhatsapp.value = localStorage.getItem('clientWhatsapp') || "";
  const savedPicadas = localStorage.getItem('picadas');
  deliveryTime.value = localStorage.getItem('deliveryTime') || "";

  if (!savedPicadas) {
    buildPicadas(1);
    return;
  }

  try {
    picadas = JSON.parse(savedPicadas);
  } catch {
    buildPicadas(1);
    return;
  }

  // üëá restaurar picada activa
  const savedActive = Number(localStorage.getItem('activePicada'));
  active = Number.isInteger(savedActive) && savedActive < picadas.length
    ? savedActive
    : 0;

  clientName.value = localStorage.getItem('clientName') || "";
  orderDate.value = localStorage.getItem('orderDate') || "";
  addr.value = localStorage.getItem('addr') || "";

  const savedZone = localStorage.getItem('zone');
  if (savedZone !== null) {
    zone.value = savedZone;
    if (savedZone) {
      setZone();
    } else {
      zoneName = "";
      ship = 0;
    }
  }

  // üî• CLAVE: sincronizar banner y UI
  if (picadas[active]?.model) {
    syncBannerWithModel(picadas[active].model);
  }

  renderConfig();   // üëà reconstruye TODA la UI
}


function buildPicadas(n){
  picadas = Array.from({ length: n }, () => ({
    model: null,
    size: null,
    price: 0
  }));
  active = 0;
  renderConfig();
}

function resetAll(){
  // 1. borrar estado guardado
  localStorage.removeItem('picadas');
  localStorage.removeItem('clientName');
  localStorage.removeItem('orderDate');
  localStorage.removeItem('addr');
  localStorage.removeItem('zone');
  localStorage.removeItem('scrollY');
  clientWhatsapp.value = "";
localStorage.removeItem('clientWhatsapp');

  // 2. resetear variables
  ship = 0;
  zoneName = "";
  total = 0;
  active = 0;

  // 3. limpiar inputs
  clientName.value = "";
  orderDate.value = "";
  addr.value = "";
  zone.value = "";

  // 4. volver al estado inicial real
  buildPicadas(1);

  // 5. reset visual
  showSlide(0, false);
  summary.innerHTML = "Complet√° todos los pasos para poder ir a pagar.";
  payBtn.classList.remove("enabled");

    document.getElementById('cartTotal').textContent = '$0';

 sessionStorage.removeItem('mp_init_point');
sessionStorage.removeItem('order_fingerprint');
}

function resetForNextOrder() {
  // üîπ Reset de inputs y variables locales
  clientName.value = "";
  orderDate.value = "";
  addr.value = "";
  zone.value = "";
  zoneName = "";
  ship = 0;
  total = 0;
  active = 0;

  // üîπ Limpiar picadas y generar un nuevo array vac√≠o con 1 picada
  buildPicadas(1);

  // üîπ Reset visual y botones
  summary.innerHTML = "Complet√° todos los pasos para poder ir a pagar.";
  payBtn.classList.remove("enabled");
  payBtn.disabled = false;
  payBtn.style.opacity = 1;
  payBtn.textContent = "Enviar pedido";
  document.getElementById('cartTotal').textContent = '$0';

  // üîπ Limpiar errores visuales
  document.querySelectorAll('.control').forEach(el => el.classList.remove('error'));

  // üîπ Guardar estado vac√≠o en localStorage para la nueva sesi√≥n de pedido
  saveState();


// üîê Limpiar preferencia de Mercado Pago
sessionStorage.removeItem('mp_init_point');

}



function setActivePicada(i){
  active = i;

  const m = picadas[active].model;
  if(m){
    syncBannerWithModel(m);
  }

  saveState();
  renderConfig();
}
function setModel(model){
  const current = picadas[active];

  if(current.model === model){
    // si el modelo ya est√° seleccionado, lo deselecciona
    current.model = null;

    // üîπ Resetear tama√±o y precio tambi√©n
    current.size = null;
    current.price = 0;
  } else {
    current.model = model;
  }

  // sincroniza banner
  syncBannerWithModel(current.model);

  saveState();
  renderConfig();
}


function addPicada(){
  if(picadas.length >= 6) return;

  picadas.push({
    model: null,
    size: null,
    price: 0
  });

  active = picadas.length - 1;
  saveState();
  renderConfig();
}


function removePicada(){
  if(picadas.length <= 1) return;

  picadas.splice(active,1);

  if(active >= picadas.length){
    active = picadas.length - 1;
  }

  saveState();
  renderConfig();
}

function removeLastPicada(){
  if(picadas.length <= 1) return;

  picadas.pop();

  if(active >= picadas.length){
    active = picadas.length - 1;
  }

  syncBannerWithModel(picadas[active].model);
  saveState();
  renderConfig();
}


function renderConfig(){

let tabs = `
<div style="display:flex;gap:8px;">

  <!-- CANTIDAD -->
  <div style="flex:1;">
    <label style="font-size:12px;">Eleg√≠ la cantidad:</label>

    <div style="display:flex;align-items:center;gap:8px;">
      <button
        class="control"
        style="width:36px;padding:8px;text-align:center;"
        onclick="removeLastPicada()"
        ${picadas.length <= 1 ? 'disabled' : ''}>
        ‚àí
      </button>

      <div style="flex:1;text-align:center;font-size:16px;">
        ${picadas.length}
      </div>

      <button
        class="control"
        style="width:36px;padding:8px;text-align:center;"
        onclick="addPicada()">
        +
      </button>
    </div>
  </div>

  <!-- EDITAR -->
  <div style="flex:1;">
    <label>Editar</label>
    <select class="control" onchange="setActivePicada(Number(this.value))">
      ${picadas.map((_,i)=>`
        <option value="${i}" ${i===active?'selected':''}>
          Picada ${i+1}
        </option>
      `).join("")}
    </select>
  </div>

</div>
`;

 const p = picadas[active];

// üîπ NUEVO: reset color del aviso a gris si hay modelo
const hint = document.getElementById('modelHint');
if(hint){
  hint.style.color = p.model ? '#9a958d' : '#9a958d';
}


  config.innerHTML = `
    ${tabs}

<div class="section">
  <div class="model-size-grid">

    <!-- COLUMNA MODELO -->
    <div class="model-col">

      <label>Modelo</label>

      <button
        class="control ${p.model==='Cl√°sica y Elegante'?'selected':''}"
        onclick="setModel('Cl√°sica y Elegante')">
        Cl√°sica y Elegante
      </button>

      <button
        class="control ${p.model==='Fresca y Colorida'?'selected':''}"
        onclick="setModel('Fresca y Colorida')">
        Fresca y Colorida
      </button>

    </div>

    <!-- COLUMNA TAMA√ëO -->
    <div class="size-col">

      <label>Tama√±o</label>

      <button
        class="control ${p.size===4?'selected':''}"
        onclick="handleSizeClick(4, PRICES[4])">
        4 personas $50.000
      </button>

      <button
        class="control ${p.size===6?'selected':''}"
        onclick="handleSizeClick(6, PRICES[6])">
        6 personas $70.000
      </button>

      <button
        class="control ${p.size===8?'selected':''}"
        onclick="handleSizeClick(8, PRICES[8])">
        8 personas $90.000
      </button>

    </div>

  </div>

  <!-- CONTENIDO DEL MODELO -->
  <div class="model-info">
    ${
      !p.model
        ? `<div id="modelHint" style="text-align:center;">üëâ Seleccion√° un modelo para ver el contenido</div>`
        : `
          <b>ü•© Fiambres</b><br>
          ${modelData[p.model].fiambres.join(" ¬∑ ")}<br><br>

          <b>üßÄ Quesos</b><br>
          ${modelData[p.model].quesos.join(" ¬∑ ")}<br><br>

          <b>ü•£ Dips</b><br>
          ${modelData[p.model].dips.join(" ¬∑ ")}
        `
    }

    ${
      p.size && SIZE_INFO[p.size]
        ? `
          <div style="margin-top:12px;padding-top:10px;border-top:1px dashed #333;">
            <b>Tama√±o ${p.size} personas</b><br>
            Pican ${SIZE_INFO[p.size].pican}<br>
            Medidas: ${SIZE_INFO[p.size].medidas}
          </div>
        `
        : ""
    }

  </div>
</div>
      `
  }
</div>

       <label>Seleccion√° la cantidad de personas:</label>

<button
  class="control size-btn ${p.size===1?'selected':''}"
  data-size="1"
  onclick="handleSizeClick(1, PRICES[1])">
  TEST | Ejemplo ($300) ‚Äì Tama√±o demo
</button>

<button
  class="control size-btn ${p.size===4?'selected':''}"
  data-size="4"
  onclick="handleSizeClick(4, PRICES[4])">
  4 | Pican 6 ($50.000) ‚Äì Tabla 20√ó30 cm
</button>

<button
  class="control size-btn ${p.size===6?'selected':''}"
  data-size="6"
  onclick="handleSizeClick(6, PRICES[6])">
  6 | Pican 8 ($70.000) ‚Äì Tabla 28√ó48 cm
</button>

<button
  class="control size-btn ${p.size===8?'selected':''}"
  data-size="8"
  onclick="handleSizeClick(8, PRICES[8])">
  8 | Pican 12 ($90.000) ‚Äì Tabla 28√ó48 cm
</button>


      </div>
    </div>
  `;

  update();
}


function setSize(s,p){
  picadas[active].size = s;
  picadas[active].price = p;
  saveState(); // M√ìDULO 3.2
  renderConfig();
}

function handleSizeClick(s, p){
  const current = picadas[active];

  // üîπ si no hay modelo seleccionado
  if(!current.model && s !== 1){
    const modelBtns = document.querySelectorAll('.model-col button.control');
    const hint = document.getElementById('modelHint');
    if(hint) hint.style.color = '#ffffff';

    document.querySelector('.model-size-grid')
      .scrollIntoView({ behavior: 'smooth', block: 'center' });

    modelBtns.forEach(btn => {
      btn.classList.remove('model-hint');
      setTimeout(() => btn.classList.add('model-hint'), 50);
    });

    return;
  }

  // seleccionar / deseleccionar tama√±o
  current.size = current.size === s ? null : s;
  current.price = current.size ? p : 0;

  saveState();
  renderConfig(); // ‚úÖ CLAVE
}



function handleZoneChange() {
  const zoneSelect = document.getElementById('zone');
  const manualInput = document.getElementById('manualZone');

  // üëâ Opci√≥n "Seleccionar localidad"
  if (zoneSelect.value === "") {
    manualInput.style.display = 'none';
    zoneName = "";
    ship = 0;
    saveState();
    update();
    return;
  }

  // üëâ Opci√≥n manual
  if (zoneSelect.value === 'manual') {
    manualInput.style.display = 'block';
    zoneName = "";
    ship = 0;
    saveState();
    update();
    return;
  }

  // üëâ Localidad normal
  manualInput.style.display = 'none';
  setZone();
}


function setZoneManual() {
  const manualInput = document.getElementById('manualZone');
  zoneName = manualInput.value;
  ship = 0;
  saveState();
  update();
}

  
function setZone(){
 if(!zone.value)return;
 zoneName = zone.value.split('|')[0];
 ship = +zone.value.split('|')[1];
 saveState(); // M√ìDULO 3.2
 update();
}

function handleWhatsappInput() {
  let v = clientWhatsapp.value.replace(/\D/g, '');

  // m√°ximo 10 n√∫meros
  if (v.length > 10) {
    v = v.slice(0, 10);
  }

  clientWhatsapp.value = v;
  saveState();
}

function update() {
  const summaryDiv = document.querySelector('.section.summary');
  total = picadas.reduce((sum, p) => sum + (p.price || 0), 0) + (zoneName ? ship : 0);

 let txt = picadas.map((p,i) => {
    const modelName = p.model || "Seleccione un modelo";
    const size = p.size || 0;
    const price = p.price || 0;
    return `Picada ${i+1}: ${modelName} (${size} personas) ‚Äî $${price.toLocaleString()}`;
}).join("<br>") + "<br>";

const envio = zoneName ? `$${ship.toLocaleString()}` : "$0";
txt += `<br>Env√≠o a ${zoneName || "Sin localidad"}: ${envio}<br><br>`;

// Total siempre visible, aunque sea cero
const totalVisible = total || 0;
txt += `<b>Total: $${totalVisible.toLocaleString()}</b>`;



summaryDiv.innerHTML = `
  <button onclick="resetAll()"
    class="summary-close">‚úï</button>

  <div class="summary-content">

    <div class="summary-items">
      ${picadas.map((p,i)=>`
        <div class="summary-item">
          <div class="item-title">
            Picada ${i+1}
          </div>
          <div class="item-desc">
            ${p.model || "Modelo sin seleccionar"} ¬∑ ${p.size || "-"} personas
          </div>
          <div class="item-price">
            $${(p.price || 0).toLocaleString()}
          </div>
        </div>
      `).join("")}
    </div>

    <div class="summary-shipping">
      <span>Env√≠o</span>
      <span>${zoneName || "Sin localidad"}</span>
      <span>$${ship.toLocaleString()}</span>
    </div>

    <div class="summary-total">
      <span>Total</span>
      <span>$${total.toLocaleString()}</span>
    </div>
    
  </div>
`;

const allPicadasValid = picadas.every(p => p.model && p.size);

const valid =
  allPicadasValid &&
  clientName.value.trim() &&
  clientWhatsapp.value.trim() &&
  orderDate.value &&
  deliveryTime.value &&
  zoneName;


  summaryDiv.style.display = 'block'; // siempre visible
  payBtn.classList.toggle("enabled", valid);

 if(valid && !window._checkoutTracked){
  if (typeof fbq === "function") {
    fbq('trackCustom', 'FormCompleted', {
      content_name: 'Formulario Picada Completo',
      content_category: 'Picadas',
      value: total,
      currency: 'ARS',
      num_items: picadas.length
    });
  }
  window._checkoutTracked = true;
}
  if(!valid) window._checkoutTracked = false;
// üîÑ Si el pedido cambi√≥, invalidar checkout previo
const savedFingerprint = sessionStorage.getItem('order_fingerprint');
const currentFingerprint = getOrderFingerprint();

if (savedFingerprint && savedFingerprint !== currentFingerprint) {
  // üîê limpiar checkout previo
  sessionStorage.removeItem('mp_init_point');
  sessionStorage.removeItem('order_fingerprint');
}
  document.getElementById('cartTotal').textContent = `$${total.toLocaleString()}`;
}
function getFacebookIdentifiers() {
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  // FBC = Facebook Click ID, FBP = Browser ID
  const fbc = getCookie('_fbc') || null;
  const fbp = getCookie('_fbp') || null;

  return { fbc, fbp };
}

function resetPayButton() {
  payBtn.disabled = false;
  payBtn.style.opacity = 1;
  payBtn.textContent = "Pagar";
}


async function goWA() {
  const orderId = window.currentOrderId; 
  // Bloquear bot√≥n y cambiar estilo
  payBtn.disabled = true;
  payBtn.style.opacity = 0.6;
  payBtn.textContent = "Procesando...";


// üî¥ Limpiar errores previos
document.querySelectorAll('.control').forEach(el => el.classList.remove('error'));

const campos = [
  { id: 'clientName' },
  { id: 'clientWhatsapp' },
  { id: 'orderDate' },
  { id: 'deliveryTime' },
  { id: 'zone' },
  { id: 'addr' }
];


let primeroInvalido = null;

campos.forEach(c => {
  const elem = document.getElementById(c.id);
  let valor = elem.value.trim();

  // Localidad manual
  if (c.id === 'zone' && valor === 'manual') {
    const manual = document.getElementById('manualZone');
    valor = manual.value.trim();

    if (!valor) {
      manual.classList.add('error');
      if (!primeroInvalido) primeroInvalido = manual;
      return;
    }
  }

  if (!valor) {
    elem.classList.add('error');
    if (!primeroInvalido) primeroInvalido = elem;
  }
});

if (primeroInvalido) {

  // üì≥ Vibraci√≥n sutil en m√≥viles compatibles
  if (navigator.vibrate) {
    navigator.vibrate(80);
  }

  setTimeout(() => {
    primeroInvalido.scrollIntoView({
      behavior: 'smooth',
      block: 'center'
    });
  }, 50);

  payBtn.disabled = false;
  payBtn.style.opacity = 1;
  payBtn.textContent = "Pagar";
  return;
}


// Validar que todas las picadas tengan modelo y tama√±o
const incompleteIndex = picadas.findIndex(p => !p.model || !p.size);

if (incompleteIndex !== -1) {
  highlightPicada(incompleteIndex);

  payBtn.disabled = false;
  payBtn.style.opacity = 1;
  payBtn.textContent = "Pagar";
  return;
}

// üîπ Pixel Meta ‚Äì StartPayment (protegido)
if (typeof fbq === "function") {
  fbq('trackCustom', 'StartPayment', {
    content_name: 'Click Ir a Pagar',
    content_category: 'Picadas',
    value: total,
    currency: 'ARS',
    num_items: picadas.length
  });
}


  const fbIds = getFacebookIdentifiers();
  const clientUserAgent = navigator.userAgent;
  const whatsappFinal = "549" + clientWhatsapp.value;


const payload = {
  order_id: window.currentOrderId,
  token: window.currentToken,
  nombre: clientName.value,
  whatsapp: whatsappFinal,
  envio: ship,
  horario: deliveryTime.value,
  picadas: picadas.map(p => ({
    model: p.model,
    size: p.size,
    price: p.price
  }))
};


  try {
    // ‚úÖ ESCRIBE EN EL SHEET (fire & forget, NO await)
    fetch(ORDERS_API_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8'
      },
      body: new URLSearchParams({
        data: JSON.stringify(payload)
      })
    });


saveState();
    
let mpRes;
try {


// limpiar preferencia previa
sessionStorage.removeItem('mp_init_point');
sessionStorage.removeItem('order_fingerprint');

  mpRes = await fetch("https://saboresdelfogon.com/api/mp/create-preference", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
body: JSON.stringify({
  order_id: window.currentOrderId,
  clientName: clientName.value,
  clientWhatsapp: whatsappFinal,
  total,
  fingerprint: getOrderFingerprint(),
  currency: "ARS",
  items: picadas.map(p => ({
    model: p.model,
    size: p.size,
    price: p.price
  })),
  envio: ship,
  orderDate: orderDate.value,
  deliveryTime: deliveryTime.value,
  zone: zoneName,
  address: addr.value,

  // üîë META IDENTIFIERS
  fbp: fbIds.fbp || null,
  fbc: fbIds.fbc || null,
  user_agent: clientUserAgent
})

  });
} catch (err) {
  console.error("Network error MP:", err);
  alert("No se pudo iniciar el pago. Intent√° nuevamente.");
  resetPayButton();
  return;
}

if (!mpRes.ok) {
  console.error("MP HTTP error:", mpRes.status);
  alert("No se pudo iniciar el pago. Intent√° nuevamente.");
  resetPayButton();
  return;
}

let mpData;
try {
  mpData = await mpRes.json();
} catch (err) {
  console.error("MP invalid JSON");
  alert("No se pudo iniciar el pago. Intent√° nuevamente.");
  resetPayButton();
  return;
}

if (!mpData.init_point) {
  console.error("MP missing init_point:", mpData);
  alert("No se pudo iniciar el pago. Intent√° nuevamente.");
  resetPayButton();
  return;
}

// üíæ Guardar init_point y fingerprint del pedido
sessionStorage.setItem('mp_init_point', mpData.init_point);
sessionStorage.setItem('order_fingerprint', getOrderFingerprint());


// üöÄ REDIRECCI√ìN √öNICA, SEGURA (mobile + desktop)
window.location.assign(mpData.init_point);

  } catch (err) {
    console.error("ERROR goWA:", err);
    alert("Error t√©cnico al enviar el pedido");
    resetPayButton();
  }
}

  
function openModal(src){
 modalImg.src=src;
 imgModal.style.display="flex";
}
function closeModal(){
 imgModal.style.display="none";
}
function bannerIsLocked(){
  return !!picadas[active]?.model;
}
let bannerReady = false;
const bannerSlides = [
  {
    model: "Cl√°sica y Elegante",
    type: "image",
    src: "images/IMG_7762.webp"
  },
  {
    model: "Fresca y Colorida",
    type: "image",
    src: "images/IMG_7761.webp"
  }
  // ac√° despu√©s pod√©s agregar videos
];

let bannerIndex = 0;
let bannerFrozenModel = null;
let bannerTimer = null;
let startX = 0;
let currentX = 0;

const banner = document.getElementById("heroBanner");
const track = document.getElementById("bannerTrack");
const bannerModel = document.getElementById("bannerModel");

(window.requestIdleCallback || function(cb){ setTimeout(cb, 1); })(() => {
  bannerSlides.forEach((s, index) => {
    const slide = document.createElement("div");
    slide.className = "banner-slide";

    if (s.type === "video") {
      slide.innerHTML = `<video src="${s.src}" muted playsinline></video>`;
    } else {
      const img = document.createElement("img");
      img.width = 720;
      img.height = 220;
      img.decoding = "async";

      if (index === 0) {
        img.src = s.src;
      } else {
        img.dataset.src = s.src;
        img.loading = "lazy";
      }

      slide.appendChild(img);
    }

    track.appendChild(slide);
  });

  bannerReady = true;          // üî• CLAVE
  showSlide(bannerIndex, false); // üî• fuerza render inicial
});

function showSlide(i, animate = true){
  bannerIndex = i;
  track.style.transition = animate ? "transform .6s ease" : "none";
  track.style.transform = `translateX(-${i * 100}%)`;

  const slide = bannerSlides[i];
  bannerModel.textContent = slide.model;

  // ‚ö° Lazy-load de imagen si es slide > 0
  const slideEl = track.children[i];
  const img = slideEl.querySelector('img[data-src]');
  if(img){
    img.src = img.dataset.src;
    img.removeAttribute('data-src');
  }

  clearTimeout(bannerTimer);

  if(!bannerIsLocked()){
    bannerTimer = setTimeout(nextSlide, 5000);
  }
}


function nextSlide(){
  if(bannerIsLocked()) return;
  showSlide((bannerIndex + 1) % bannerSlides.length);
}

banner.onclick = () => {
  const model = bannerSlides[bannerIndex].model;
  picadas[active].model = model;
  saveState();
  renderConfig();
};


banner.addEventListener("touchend", e => {
  const endX = e.changedTouches[0].clientX;
  const diff = endX - startX;

  if (Math.abs(diff) < 40) return;

  let newIndex;

  if (diff < 0) {
    // swipe izquierda ‚Üí siguiente
    newIndex = (bannerIndex + 1) % bannerSlides.length;
  } else {
    // swipe derecha ‚Üí anterior
    newIndex = (bannerIndex - 1 + bannerSlides.length) % bannerSlides.length;
  }

  showSlide(newIndex);

  const newModel = bannerSlides[newIndex].model;

  // üëâ SIN importar bloqueo: swipe selecciona modelo
  picadas[active].model = newModel;
  saveState();
  renderConfig();
});


function syncBannerWithModel(model){
  if (!model || !bannerReady) return;

  const i = bannerSlides.findIndex(s => s.model === model);
  if (i >= 0) showSlide(i, false);
}


window.addEventListener('scroll', () => {
  localStorage.setItem('scrollY', window.scrollY);
});
  
window.addEventListener('pageshow', () => {
  loadState();
  update();

  const fromMP = sessionStorage.getItem('mp_init_point');

  if (fromMP) {
    payBtn.disabled = false;
    payBtn.style.opacity = 1;
    payBtn.textContent = "Pagar";
  }
});


// üîÅ Fallback para refresh duro (F5 / Ctrl+R)
if (document.readyState === "complete") {
  setTimeout(() => {
    if (!config.innerHTML.trim()) {
      loadState();
      update();
    }
  }, 0);
}


// üîí bloquear zoom por gesto (iOS / Safari)
document.addEventListener('gesturestart', e => e.preventDefault());
document.addEventListener('gesturechange', e => e.preventDefault());
document.addEventListener('gestureend', e => e.preventDefault());
document.querySelectorAll('.control').forEach(el=>{
  el.addEventListener('input', ()=>{
    el.classList.remove('error');
  });

  el.addEventListener('change', ()=>{
    el.classList.remove('error');
  });
});

  
</script>
<script>
(function () {
  let pixelLoaded = false;

  function loadPixelOnce() {
    if (pixelLoaded) return;
    pixelLoaded = true;

    // üõü Cola de eventos por si fbq se llama antes
    window.fbq = window.fbq || function(){
      (window.fbq.queue = window.fbq.queue || []).push(arguments);
    };

    if (!navigator.userAgent.includes('Instagram')) {
      if ('scrollRestoration' in history) {
        history.scrollRestoration = 'manual';
      }
    }

    !function(f,b,e,v,n,t,s)
    {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
    n.callMethod.apply(n,arguments):n.queue.push(arguments)};
    if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
    n.queue=[];t=b.createElement(e);t.async=!0;
    t.src=v;s=b.getElementsByTagName(e)[0];
    s.parentNode.insertBefore(t,s)}
    (window, document,'script','https://connect.facebook.net/en_US/fbevents.js');

    fbq('init','3350400148462231');
    fbq('track','PageView');
  }

  window.addEventListener('scroll', loadPixelOnce, { once: true, passive: true });
  window.addEventListener('click', loadPixelOnce, { once: true });

})();
</script>

</body>
</html>
