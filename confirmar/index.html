<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmar pedido | Sabores del Fogón</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =================== META PIXEL =================== -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)}
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}
  (window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2992234817833383');
  fbq('track', 'PageView');
  </script>

  <style>
    :root{
      --bg:#0f0f0f;
      --card:#1b1b1b;
      --text:#cfcac2;
      --muted:#9a958d;
      --accent:#D3AE09;
      --border:#2a2a2a;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui;}
    h1{text-align:center;font-size:22px;margin:20px 0;color:var(--accent);}
    #content{max-width:720px;margin:auto;padding:16px;}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border);}
    .item{border-top:1px solid var(--border);padding-top:12px;margin-top:12px;font-size:14px;}
    .total{font-size:20px;font-weight:600;margin-top:16px;text-align:right;color:var(--accent);}
    button{width:100%;padding:18px;font-size:18px;background:var(--accent);border:none;border-radius:10px;font-weight:600;cursor:pointer;margin-top:14px;}
    input{width:100%;padding:8px;margin-top:4px;border-radius:6px;border:1px solid var(--border);background:#111;color:var(--text);}
    .msg{text-align:center;padding:18px;border-radius:12px;background:var(--card);}
    .err{color:#ff6b6b;}
    .small{text-align:center;font-size:13px;color:var(--muted);}
  </style>
</head>

<body>

<h1>Estado del pedido</h1>

<div id="content">
  <div class="msg">Cargando pedido…</div>
</div>

<script>
const API_URL = 'https://saboresfogon.com/api/pedido';
const WORKER_URL = 'https://saboresfogon.com/api/pedido';
const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxe8O8SvhDS0-21TRQgFyxTOCsMPlnuF5sdbdtzIt4wLnY92P4Y9ykQp-u30mmTGa5dNw/exec';

const params = new URLSearchParams(window.location.search);
const order_id = params.get('order_id');
const token = params.get('token');

const content = document.getElementById('content');
let pedido = null;

if (!order_id || !token) {
  content.innerHTML = '<div class="msg err">Link inválido</div>';
  throw new Error('Link inválido');
}

fetch(`${API_URL}?order_id=${order_id}&token=${token}`)
  .then(r => r.json())
  .then(data => {
    if (!data.success) throw new Error(data.error);
    pedido = data.preview || data.pedido;

    const confirmado = pedido.estado === 'CONFIRMADO';

    content.innerHTML = `
      <div class="card">
        <b>Pedido:</b> ${pedido.order_id}<br>
        <b>Nombre:</b> ${pedido.nombre}<br>
        <b>Estado:</b>
        <span style="color:${confirmado ? '#4caf50' : '#ffb300'}">
          ${confirmado ? 'Confirmado' : 'Pendiente'}
        </span>
      </div>

      <div class="card">
        ${pedido.items.map((i, idx) => `
          <div class="item">
            <b>Picada ${idx + 1}</b><br>

            Modelo:
            ${confirmado
              ? i.modelo
              : `<input data-idx="${idx}" data-field="modelo" value="${i.modelo}">`
            }

            Tamaño:
            ${confirmado
              ? i.tamano + ' personas'
              : `<input type="number" min="1" data-idx="${idx}" data-field="tamano" value="${i.tamano}">`
            }

            <div>Subtotal: $${Number(i.subtotal).toLocaleString()}</div>
          </div>
        `).join('')}

        <div class="total">
          Total: $${Number(pedido.total).toLocaleString()}
        </div>
      </div>

      ${confirmado ? `
        <div class="msg">✅ Pedido confirmado</div>
      ` : `
        <button onclick="guardarCambios()">Guardar cambios</button>
        <button onclick="confirmarPedido()">Confirmar pedido</button>
      `}

      <p class="small">
        ${confirmado
          ? 'Este pedido ya no puede modificarse.'
          : 'Podés editar el pedido antes de confirmarlo.'}
      </p>
    `;
  })
  .catch(err => {
    content.innerHTML = `<div class="msg err">${err.message}</div>`;
  });

// ===== GUARDAR CAMBIOS EN SHEET =====
async function guardarCambios() {
  const inputs = document.querySelectorAll('[data-idx]');
  const picadas = {};

  inputs.forEach(i => {
    const idx = i.dataset.idx;
    const field = i.dataset.field;
    picadas[idx] ??= {};
    picadas[idx][field] = i.value;
  });

  const payload = {
    action: 'update',
    order_id,
    token,
    picadas: Object.values(picadas)
  };

  const res = await fetch(SHEET_API_URL, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  const json = await res.json();
  if (!json.success) {
    alert('Error al guardar cambios');
    return;
  }

  alert('Cambios guardados correctamente');
}

// ===== CONFIRMAR (CAPI) =====
async function confirmarPedido() {
  const payload = {
    action: 'purchase',
    order_id: pedido.order_id,
    token,
    total: pedido.total,
    currency: 'ARS',
    items: pedido.items,
    fbc: getCookie('_fbc'),
    fbp: getCookie('_fbp')
  };

  await fetch(WORKER_URL, {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify(payload)
  });

  location.reload();
}

function getCookie(name) {
  const m = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return m ? m[2] : null;
}
</script>

</body>
</html>
