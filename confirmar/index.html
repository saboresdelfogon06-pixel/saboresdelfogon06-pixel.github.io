<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Confirmar pedido | Sabores del Fog√≥n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- =================== META PIXEL =================== -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)}
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}
  (window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2992234817833383');
  fbq('track', 'PageView');
  </script>
  <noscript>
    <img height="1" width="1" style="display:none"
      src="https://www.facebook.com/tr?id=2992234817833383&ev=PageView&noscript=1"
    />
  </noscript>
  <!-- =================== FIN META PIXEL =================== -->

  <style>
    :root{
      --bg:#0f0f0f;
      --card:#1b1b1b;
      --text:#cfcac2;
      --muted:#9a958d;
      --accent:#D3AE09;
      --border:#2a2a2a;
    }
    *{box-sizing:border-box;}
    body{margin:0;background:var(--bg);color:var(--text);font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;}
    h1{text-align:center;font-size:22px;font-weight:600;margin:20px 0;color:var(--accent);}
    #content{max-width:720px;margin:auto;padding:16px;}
    .card{background:var(--card);border-radius:12px;padding:16px;margin-bottom:16px;border:1px solid var(--border);}
    .item{border-top:1px solid var(--border);padding-top:12px;margin-top:12px;font-size:14px;line-height:1.5;}
    .total{font-size:20px;font-weight:600;margin-top:16px;text-align:right;color:var(--accent);}
    button{width:100%;padding:18px;font-size:18px;background:var(--accent);color:#000;border:none;border-radius:10px;font-weight:600;cursor:pointer;margin-top:20px;}
    button:hover{opacity:.9;}
    .msg{background:var(--card);padding:20px;border-radius:12px;text-align:center;border:1px solid var(--border);}
    .err{color:#ff6b6b;}
    .small{font-size:13px;color:var(--muted);text-align:center;margin-top:12px;}
  </style>
</head>

<body>

<h1> pedido</h1>

<div id="content">
  <div class="msg">Cargando pedido‚Ä¶</div>
</div>

<script>
const API_URL = 'https://saboresfogon.com/api/pedido';
const WORKER_URL = 'https://saboresfogon.com/api/pedido';
const WHATSAPP_NUMBER = '5491123284020';

const params = new URLSearchParams(window.location.search);
const order_id = params.get('order_id');
const token = params.get('token');

const content = document.getElementById('content');
let pedido = null;

if (!order_id || !token) {
  content.innerHTML = `<div class="msg err">Link inv√°lido o incompleto</div>`;
  throw new Error('Link inv√°lido');
}

// ==================== CARGAR PEDIDO ====================
fetch(`${API_URL}?order_id=${order_id}&token=${token}`)
  .then(r => r.json())
  .then(data => {
    if (!data.success) throw new Error(data.error || 'Pedido no encontrado');
    pedido = data.preview;

  const estado = pedido.status === "confirmed";

content.innerHTML = `
  <div class="card">
    <b>Pedido ID:</b> ${pedido.order_id}<br>
    <b>Nombre:</b> ${pedido.clientName}<br>
    <b>Estado:</b>
    <span style="color:${estado ? '#4caf50' : '#ffb300'}">
      ${estado ? 'Pedido confirmado' : 'Pendiente de confirmaci√≥n'}
    </span>
  </div>

  <div class="card">
    ${pedido.items.map((i, idx) => `
      <div class="item">
        <b>Picada ${idx + 1}</b><br>
        Modelo: ${i.model}<br>
        Tama√±o: ${i.size} personas<br>
        Subtotal: $${Number(i.price).toLocaleString()}
      </div>
    `).join('')}

    <div class="total">
      Total: $${Number(pedido.total).toLocaleString()}
    </div>
  </div>

  ${
    estado
      ? `<div class="msg">‚úÖ Este pedido ya fue confirmado.</div>`
      : `<button onclick="confirmarPedido()">Confirmar pedido</button>`
  }

  <p class="small">
    ${estado
      ? 'Este comprobante sirve como registro interno del pedido.'
      : 'Confirm√° el pedido para finalizar el registro.'}
  </p>
`;
  .catch(err => {
    content.innerHTML = `<div class="msg err">${err.message}</div>`;
  });

// ==================== CONFIRMAR ====================
async function confirmarPedido() {
  if (!pedido) return;

  // Pixel browser
  fbq('track', 'Purchase', {
    value: pedido.total,
    currency: 'ARS'
  });

  const purchasePayload = {
    action: 'purchase',
    order_id: pedido.order_id,
    token: token,
    clientName: pedido.clientName,
    total: pedido.total,
    currency: 'ARS',
    items: pedido.items,
    fbc: getCookie('_fbc'),
    fbp: getCookie('_fbp'),
  };

  try {
    const res = await fetch(WORKER_URL, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(purchasePayload)
    });

    const json = await res.json();

    if (json.stage === "already_confirmed") {
      alert("Este pedido ya estaba confirmado.");
    }

    // üîÑ Recargar para mostrar estado confirmado
    location.reload();

  } catch (err) {
    alert('Error t√©cnico al confirmar el pedido');
  }
}

// =================== Cookies ====================
function getCookie(name) {
  const match = document.cookie.match(new RegExp('(^| )' + name + '=([^;]+)'));
  return match ? match[2] : null;
}
</script>

</body>
</html>
